<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PathGen AI - Your AI Fortnite Coach</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            /* Solid background to avoid jagged gradient while scrolling */
            background: #0a0a0a;
            color: #ffffff;
            height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* Navbar */
        .navbar {
            position: fixed;
            top: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
        }

        .navbar-container {
            backdrop-filter: blur(16px);
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 50px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6), 
                        0 0 0 1px rgba(255, 255, 255, 0.03),
                        inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #FFFFFF;
            text-decoration: none;
            padding: 0 8px;
            margin-right: 4px;
        }

        .logo-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .logo-icon svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        .nav-links {
            display: flex;
            gap: 2px;
            align-items: center;
            margin: 0 8px;
        }

        .nav-link {
            color: #A0A0A0;
            text-decoration: none;
            font-size: 0.875rem;
            padding: 6px 14px;
            border-radius: 25px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 3px;
            font-weight: 500;
        }

        .nav-link:hover {
            color: #FFFFFF;
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-link .caret {
            font-size: 8px;
            margin-left: 1px;
            opacity: 0.7;
        }

        .nav-link.external::after {
            content: '\2197';
            font-size: 10px;
            opacity: 0.6;
            margin-left: 2px;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Ambient background visuals to match app aesthetic */
        .ai-bg-grid {
            position: fixed;
            inset: 0;
            z-index: 0;
            background-image: linear-gradient(rgba(255,255,255,0.04) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(255,255,255,0.04) 1px, transparent 1px);
            background-size: 36px 36px;
            -webkit-mask-image: radial-gradient(60% 50% at 50% 40%, rgba(0,0,0,0.8), transparent 70%);
                    mask-image: radial-gradient(60% 50% at 50% 40%, rgba(0,0,0,0.8), transparent 70%);
            pointer-events: none;
        }
        .ai-bg-orb {
            position: fixed;
            filter: blur(60px);
            opacity: 0.4;
            border-radius: 9999px;
            pointer-events: none;
            z-index: 0;
        }
        .ai-bg-orb.orb-1 {
            width: 420px;
            height: 420px;
            left: -120px;
            top: 140px;
            background: radial-gradient(circle at 30% 30%, rgba(139, 92, 246, 0.6), rgba(139, 92, 246, 0) 60%);
        }
        .ai-bg-orb.orb-2 {
            width: 520px;
            height: 520px;
            right: -160px;
            bottom: -80px;
            background: radial-gradient(circle at 70% 60%, rgba(59, 130, 246, 0.55), rgba(59, 130, 246, 0) 60%);
        }

        /* Input monospace to match overall theme */
        .input-field {
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace;
        }

        .cta-button {
            padding: 6px 18px;
            background: #0A0A0A;
            border: 1px solid rgba(139, 92, 246, 0.5);
            border-radius: 50px;
            color: #FFFFFF;
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
        }

        .cta-button:hover {
            background: #151515;
            border-color: rgba(139, 92, 246, 0.8);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.5);
        }

        .cta-button::after {
            content: '→';
            font-size: 14px;
        }

        .user-info {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 4px 12px 4px 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 25px;
            margin-left: 8px;
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #3b82f6 0%, #a855f7 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .user-name {
            font-size: 14px;
            color: #ffffff;
            font-weight: 500;
        }

        .user-info:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        /* Dropdowns */
        .dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 12px);
            right: 0;
            min-width: 220px;
            background: rgba(15, 15, 15, 0.98);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6),
                        0 0 0 1px rgba(255, 255, 255, 0.05);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 200;
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            border-radius: 10px;
            color: #d1d5db;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .dropdown-item:hover {
            background: rgba(79, 140, 255, 0.1);
            color: #ffffff;
        }

        .dropdown-item-icon {
            font-size: 16px;
            width: 20px;
        }

        .dropdown-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 6px 0;
        }

        .dropdown-item.danger {
            color: #ef4444;
        }

        .dropdown-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Features Dropdown */
        #featuresDropdown {
            left: 0;
            right: auto;
        }

        /* Chat History Toggle */
        .chat-history-toggle {
            position: fixed;
            top: 24px;
            left: 24px;
            z-index: 101;
            width: 44px;
            height: 44px;
            background: #1a1a1a;
            border: 1px solid rgba(79, 140, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(79, 140, 255, 0.2);
            opacity: 1;
            visibility: visible;
        }

        .chat-history-toggle.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .chat-history-toggle svg {
            width: 20px;
            height: 20px;
            color: #a0a0a0;
        }

        .chat-history-toggle:hover {
            background: #2a2a2a;
            border-color: rgba(79, 140, 255, 0.5);
            box-shadow: 0 0 20px rgba(79, 140, 255, 0.4);
            transform: scale(1.05);
        }

        .chat-history-toggle:hover svg {
            color: #4f8cff;
        }

        /* Chat History Sidebar */
        .chat-history-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 300px;
            height: 100vh;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(16px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            padding: 20px;
            overflow-y: auto;
        }

        .chat-history-sidebar.open {
            transform: translateX(0);
        }

        .history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
        }

        .new-chat-btn {
            width: 32px;
            height: 32px;
            background: #4f8cff;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 300;
            transition: all 0.2s ease;
            margin-right: 8px;
        }

        .new-chat-btn:hover {
            background: #3b7ce0;
            transform: scale(1.1);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .close-history {
            width: 32px;
            height: 32px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            color: #a0a0a0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-history:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: #4f8cff;
            color: #4f8cff;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .history-item {
            padding: 12px 16px;
            background: rgba(26, 26, 26, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .history-item:hover {
            background: rgba(26, 26, 26, 0.9);
            border-color: #4f8cff;
        }

        .history-item.active {
            background: rgba(79, 140, 255, 0.15);
            border-color: #4f8cff;
        }

        .history-item-title {
            font-size: 14px;
            color: #ffffff;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-item-date {
            font-size: 12px;
            color: #6b7280;
        }

        /* History item action buttons */
        .history-item-actions {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 6px;
        }
        .history-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.03);
            color: #d1d5db;
            display: grid;
            place-items: center;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .history-action-btn:hover {
            border-color: #4f8cff;
            color: #ffffff;
            background: rgba(79, 140, 255, 0.12);
        }
        .history-action-btn.danger:hover {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.12);
            color: #fff;
        }
        .history-action-btn svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
        }

        .history-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .history-overlay.open {
            opacity: 1;
            pointer-events: all;
        }

        /* Main Container */
        .main-container {
            display: flex;
            flex-direction: column;
            padding-top: 100px;
            padding-bottom: 180px;
        }

        /* Welcome State */
        .welcome-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 24px;
            min-height: calc(100vh - 280px);
        }

        .welcome-greeting {
            font-size: 40px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 48px;
            max-width: 800px;
        }

        @media (max-width: 768px) {
            .welcome-greeting {
                font-size: 28px;
                margin-bottom: 32px;
            }
        }

        .suggestion-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            max-width: 1200px;
            width: 100%;
            margin-bottom: 0;
        }

        @media (max-width: 1200px) {
            .suggestion-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .suggestion-grid {
                grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        }

        @media (max-width: 480px) {
            .suggestion-grid {
                grid-template-columns: 1fr;
            }
        }

        .suggestion-card {
            background: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .suggestion-card:hover {
            transform: scale(1.05);
            border-color: #4f8cff;
            background: #1f1f1f;
        }

        .suggestion-emoji {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .suggestion-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #ffffff;
        }

        .suggestion-desc {
            font-size: 13px;
            color: #9ca3af;
            line-height: 1.4;
        }

        /* Chat State */
        .chat-state {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .messages-container {
            flex: 1;
            max-width: 56rem;
            margin: 0 auto;
            width: 100%;
            padding: 24px;
        }

        .message {
            display: flex;
            margin-bottom: 24px;
                opacity: 0;
            transform: translateY(20px);
            animation: messageAppear 0.3s ease forwards;
            }

        @keyframes messageAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.ai {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 28rem;
            padding: 18px 22px;
            border-radius: 20px;
            line-height: 1.6;
            font-size: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 768px) {
            .message-bubble {
                max-width: 85%;
            }
        }

        .message.user .message-bubble {
            background: #4f8cff;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.ai .message-bubble {
            background: #1a1a1a;
            color: white;
            border-bottom-left-radius: 4px;
        }

        .message-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message-content strong,
        .message-content b {
            font-weight: 700;
            color: #4f8cff;
        }

        .message.user .message-content strong,
        .message.user .message-content b {
            color: white;
        }

        .message-footer {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
            font-size: 12px;
            color: #6b7280;
        }

        .message.user .message-footer {
            justify-content: flex-end;
            color: #60a5fa;
        }

        .message-actions {
            display: flex;
            gap: 8px;
        }

        .message-action-btn {
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #9ca3af;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .message-action-btn svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
        }

        .message-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #4f8cff;
            color: #4f8cff;
        }

        .message-sources {
            margin-top: 12px;
            padding: 16px;
            background: rgba(26, 26, 26, 0.6);
            border: 1px solid rgba(79, 140, 255, 0.2);
            border-radius: 16px;
            font-size: 13px;
        }

        .sources-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #4f8cff;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .source-item {
            padding: 10px 12px;
            background: rgba(79, 140, 255, 0.05);
            border: 1px solid rgba(79, 140, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .source-item:last-child {
            margin-bottom: 0;
        }

        .source-item:hover {
            background: rgba(79, 140, 255, 0.1);
            border-color: rgba(79, 140, 255, 0.3);
        }

        .source-title {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .source-description {
            color: #9ca3af;
            font-size: 12px;
            line-height: 1.4;
        }

        .source-link {
            color: #4f8cff;
            font-size: 11px;
            margin-top: 6px;
            display: block;
            text-decoration: none;
        }

        .source-link:hover {
            text-decoration: underline;
        }

        /* Video Integration Styles */
        .timestamp-link {
            color: #4f8cff;
            text-decoration: underline;
            cursor: pointer;
            transition: color 0.2s ease;
            font-weight: 500;
        }

        .timestamp-link:hover {
            color: #60a5fa;
        }

        .video-citation {
            margin-top: 12px;
            margin-bottom: 12px;
        }

        .video-thumbnail-container {
            position: relative;
            width: 100%;
            max-width: 560px;
            margin-bottom: 8px;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            background: rgba(26, 26, 26, 0.6);
            border: 1px solid rgba(79, 140, 255, 0.2);
            transition: all 0.2s ease;
        }

        .video-thumbnail-container:hover {
            border-color: rgba(79, 140, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 140, 255, 0.2);
        }

        .video-thumbnail {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
            display: block;
        }

        .video-thumbnail-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .video-thumbnail-container:hover .video-thumbnail-overlay {
            background: rgba(0, 0, 0, 0.2);
        }

        .video-play-icon {
            width: 64px;
            height: 64px;
            background: rgba(79, 140, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transition: transform 0.2s ease;
        }

        .video-thumbnail-container:hover .video-play-icon {
            transform: scale(1.1);
        }

        .video-play-icon::after {
            content: '';
            width: 0;
            height: 0;
            border-left: 20px solid white;
            border-top: 12px solid transparent;
            border-bottom: 12px solid transparent;
            margin-left: 6px;
        }

        .video-info {
            padding: 12px;
            background: rgba(26, 26, 26, 0.8);
            border-top: 1px solid rgba(79, 140, 255, 0.1);
        }

        .video-title {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 4px;
            font-size: 14px;
            line-height: 1.4;
        }

        .video-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .video-action-btn {
            padding: 6px 12px;
            background: rgba(79, 140, 255, 0.1);
            border: 1px solid rgba(79, 140, 255, 0.3);
            border-radius: 6px;
            color: #4f8cff;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }

        .video-action-btn:hover {
            background: rgba(79, 140, 255, 0.2);
            border-color: rgba(79, 140, 255, 0.5);
            color: #60a5fa;
        }

        .video-action-btn svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
        }

        .video-inline-player {
            width: 100%;
            max-width: 560px;
            border-radius: 12px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(79, 140, 255, 0.2);
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            margin-top: 8px;
        }

        .video-inline-player iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .video-timestamp-info {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 4px;
        }

        /* Quick Actions Styles */
        .quick-actions {
            display: none; /* Hidden in welcome state */
        }

        /* Quick Actions Floating Button */
        .quick-actions-float-btn {
            position: fixed;
            right: 24px;
            bottom: calc(24px + 12px + 28px);
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #4f8cff 0%, #3b7ce0 100%);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(79, 140, 255, 0.4), 0 0 0 0 rgba(79, 140, 255, 0.5);
            animation: pulseGlow 2s ease-in-out infinite;
            transform: translateY(50%);
        }

        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 4px 20px rgba(79, 140, 255, 0.4), 0 0 0 0 rgba(79, 140, 255, 0.5);
            }
            50% {
                box-shadow: 0 4px 25px rgba(79, 140, 255, 0.6), 0 0 0 4px rgba(79, 140, 255, 0.2);
            }
        }

        .quick-actions-float-btn:hover {
            background: linear-gradient(135deg, #3b7ce0 0%, #2d66cc 100%);
            transform: translateY(50%) scale(1.1);
            box-shadow: 0 6px 30px rgba(79, 140, 255, 0.6), 0 0 0 8px rgba(79, 140, 255, 0.15);
            animation: none;
        }

        .quick-actions-float-btn:active {
            transform: translateY(50%) scale(0.95);
        }

        .quick-actions-float-btn svg {
            width: 24px;
            height: 24px;
            stroke: white;
            stroke-width: 2;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
        }

        @media (max-width: 768px) {
            .quick-actions-float-btn {
                right: 16px;
                bottom: calc(16px + 12px + 24px);
                width: 48px;
                height: 48px;
            }

            .quick-actions-float-btn svg {
                width: 20px;
                height: 20px;
            }
        }

        /* Quick Actions Popup */
        .quick-actions-popup {
            position: fixed;
            bottom: 120px;
            right: 24px;
            width: 420px;
            max-height: 600px;
            background: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }

        @media (max-width: 768px) {
            .quick-actions-popup {
                right: 12px;
                left: 12px;
                width: auto;
                bottom: 100px;
            }
        }

        .quick-actions-popup.open {
            display: flex;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .quick-actions-popup-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(26, 26, 26, 0.8);
        }

        .quick-actions-popup-title {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quick-actions-popup-close {
            width: 28px;
            height: 28px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 6px;
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .quick-actions-popup-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .quick-actions-popup-content {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        .quick-actions-header {
            display: none; /* Not needed in popup */
        }

        .quick-actions-title {
            font-size: 15px;
            font-weight: 600;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 8px;
            text-align: center;
        }

        .quick-actions-title::before {
            content: '⚡';
            font-size: 18px;
            filter: drop-shadow(0 0 6px rgba(79, 140, 255, 0.4));
            display: inline-block;
            margin-right: 2px;
        }

        .quick-actions-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            background: rgba(26, 26, 26, 0.4);
            padding: 3px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            justify-content: center;
            width: 100%;
        }
        
        .quick-actions-popup .quick-actions-tabs {
            margin-bottom: 16px;
        }

        .quick-action-tab {
            padding: 6px 12px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: #9ca3af;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .quick-action-tab.active {
            background: rgba(79, 140, 255, 0.15);
            color: #4f8cff;
            box-shadow: 0 0 0 1px rgba(79, 140, 255, 0.3);
        }

        .quick-action-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
        }

        .quick-actions-content {
            display: none;
            animation: fadeIn 0.2s ease;
            width: 100%;
        }
        
        .quick-actions-popup .quick-actions-content {
            max-width: 100%;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .quick-actions-content.active {
            display: block;
        }

        .quick-action-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            width: 100%;
        }

        .quick-action-item {
            padding: 10px 14px;
            background: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }

        .quick-action-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #4f8cff;
            transform: scaleY(0);
            transition: transform 0.2s ease;
        }

        .quick-action-item:hover {
            background: rgba(26, 26, 26, 0.95);
            border-color: #4f8cff;
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(79, 140, 255, 0.15);
        }

        .quick-action-item:hover::before {
            transform: scaleY(1);
        }

        .quick-action-item-text {
            color: #ffffff;
            font-size: 13px;
            line-height: 1.4;
            flex: 1;
            font-weight: 500;
        }

        .quick-action-item-icon {
            color: #9ca3af;
            font-size: 14px;
            transition: all 0.2s ease;
            margin-left: 10px;
        }

        .quick-action-item:hover .quick-action-item-icon {
            color: #4f8cff;
            transform: translateX(3px);
        }

        .template-input {
            padding: 7px 10px;
            background: rgba(26, 26, 26, 0.8);
            border: 1px solid rgba(79, 140, 255, 0.2);
            border-radius: 6px;
            color: #ffffff;
            font-size: 12px;
            width: 110px;
            margin: 0 4px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
        }

        .template-input::placeholder {
            color: #6b7280;
        }

        .template-input:focus {
            outline: none;
            border-color: #4f8cff;
            background: rgba(26, 26, 26, 0.95);
            box-shadow: 0 0 0 2px rgba(79, 140, 255, 0.15);
        }

        .template-submit {
            padding: 7px 14px;
            background: #4f8cff;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 6px;
            box-shadow: 0 0 8px rgba(79, 140, 255, 0.3);
        }

        .template-submit:hover {
            background: #3b7ce0;
            transform: translateY(-1px);
            box-shadow: 0 2px 12px rgba(79, 140, 255, 0.4);
        }

        .template-submit:active {
            transform: translateY(0);
        }

        .multi-question-mode {
            padding: 12px;
            background: rgba(26, 26, 26, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            transition: all 0.2s ease;
            width: 100%;
        }

        .multi-question-mode:hover {
            border-color: rgba(79, 140, 255, 0.3);
            background: rgba(26, 26, 26, 0.8);
        }

        .multi-question-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .multi-question-title {
            font-size: 13px;
            font-weight: 600;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .multi-question-toggle {
            font-size: 11px;
            color: #4f8cff;
            cursor: pointer;
            padding: 3px 8px;
            background: rgba(79, 140, 255, 0.1);
            border: 1px solid rgba(79, 140, 255, 0.3);
            border-radius: 5px;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .multi-question-toggle:hover {
            background: rgba(79, 140, 255, 0.2);
            border-color: rgba(79, 140, 255, 0.5);
            color: #60a5fa;
        }

        .multi-question-input {
            width: 100%;
            background: rgba(10, 10, 10, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px 12px;
            color: #ffffff;
            font-size: 12px;
            font-family: 'Inter', sans-serif;
            resize: vertical;
            min-height: 60px;
            margin-top: 10px;
            transition: all 0.2s ease;
            line-height: 1.4;
        }

        .multi-question-input:focus {
            outline: none;
            border-color: #4f8cff;
            background: rgba(10, 10, 10, 0.8);
            box-shadow: 0 0 0 3px rgba(79, 140, 255, 0.15);
        }

        .multi-question-input::placeholder {
            color: #6b7280;
        }

        .upload-area {
            margin-top: 12px;
            padding: 24px;
            border: 2px dashed rgba(79, 140, 255, 0.3);
            border-radius: 12px;
            background: rgba(79, 140, 255, 0.05);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(79, 140, 255, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .upload-area:hover {
            border-color: #4f8cff;
            background: rgba(79, 140, 255, 0.1);
            box-shadow: 0 4px 16px rgba(79, 140, 255, 0.15);
        }

        .upload-area:hover::before {
            opacity: 1;
        }

        .upload-area.drag-over {
            border-color: #4f8cff;
            background: rgba(79, 140, 255, 0.15);
            border-style: solid;
            box-shadow: 0 0 24px rgba(79, 140, 255, 0.3);
        }

        .upload-area-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            color: #4f8cff;
            opacity: 0.8;
            transition: all 0.2s ease;
        }

        .upload-area:hover .upload-icon {
            opacity: 1;
            transform: scale(1.1);
        }

        .upload-text {
            font-size: 14px;
            color: #ffffff;
            font-weight: 500;
        }

        .upload-hint {
            font-size: 12px;
            color: #9ca3af;
        }

        .file-preview-container {
            margin-top: 12px;
            position: relative;
            display: inline-block;
            max-width: 240px;
            max-height: 240px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(79, 140, 255, 0.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .file-preview-container img {
            width: 100%;
            height: 100%;
            max-width: 240px;
            max-height: 240px;
            object-fit: cover;
            display: block;
        }

        .file-preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
            pointer-events: none;
        }

        .file-preview-container:hover .file-preview-overlay {
            background: rgba(0, 0, 0, 0.5);
            pointer-events: all;
        }

        .remove-file-btn-overlay {
            width: 36px;
            height: 36px;
            background: rgba(239, 68, 68, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .file-preview-container:hover .remove-file-btn-overlay {
            display: flex;
        }

        .remove-file-btn-overlay:hover {
            background: rgba(239, 68, 68, 1);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
        }

        .remove-file-btn-overlay svg {
            width: 18px;
            height: 18px;
            stroke: white;
            stroke-width: 2.5;
        }

        /* Loading Indicator */
        .loading-message {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 24px;
        }

        .loading-bubble {
            background: #1a1a1a;
            padding: 18px 22px;
            border-radius: 20px;
            border-bottom-left-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #9ca3af;
        }

        .loading-dots {
            display: flex;
            gap: 6px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: #4f8cff;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .loading-dot:nth-child(1) {
            animation-delay: 0ms;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 150ms;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 300ms;
        }

        @keyframes bounce {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* Input Section */
        .input-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px 24px 24px;
            z-index: 50;
        }

        .input-container {
            max-width: 750px;
            margin: 0 auto;
        }

        .model-preview {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(26, 26, 26, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-bottom: 12px;
            font-size: 13px;
            color: #9ca3af;
        }

        .model-preview strong {
            color: #4f8cff;
            font-weight: 600;
        }

        .input-wrapper {
            position: relative;
            background: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 28px;
            padding: 14px 100px 14px 20px;
            transition: all 0.2s ease;
            width: 100%;
            max-width: 100%;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-wrapper:focus-within {
            border-color: #4f8cff;
            box-shadow: 0 0 0 3px rgba(79, 140, 255, 0.1);
        }

        .chat-input {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            color: white;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            resize: none;
            min-height: 24px;
            max-height: 200px;
        }

        .chat-input::placeholder {
            color: #6b7280;
        }

        .send-button {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            background: #4f8cff;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 12px rgba(79, 140, 255, 0.3);
        }

        .send-button:hover:not(:disabled) {
            transform: translateY(-50%) scale(1.08);
            background: #3b7ce0;
            box-shadow: 0 0 20px rgba(79, 140, 255, 0.5);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-button.loading {
            pointer-events: none;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .credit-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
            font-size: 13px;
            color: #9ca3af;
        }

        .credit-indicator.insufficient {
            color: #ef4444;
        }

        .get-credits-btn {
            padding: 4px 12px;
            background: #4f8cff;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .get-credits-btn:hover {
            background: #3b7ce0;
        }


        /* Responsive adjustments */
        @media (max-width: 968px) {
            .nav-links {
                display: none;
            }

            .welcome-greeting {
                font-size: 28px;
                margin-bottom: 32px;
            }

            .suggestion-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .messages-container {
                padding: 16px;
            }

            .input-section {
                padding: 12px 16px 16px;
            }

            .chat-history-toggle {
                top: 24px;
                left: 16px;
                width: 40px;
                height: 40px;
            }

            .chat-history-sidebar {
                width: 280px;
            }
        }

        @media (max-width: 480px) {
            .suggestion-grid {
                grid-template-columns: 1fr;
            }

            .logo span {
                font-size: 0.8rem;
            }

            .chat-history-sidebar {
                width: 100%;
                max-width: 300px;
            }

            .model-preview {
                font-size: 11px;
                padding: 6px 12px;
            }

            .quick-actions {
                margin-top: -16px;
                padding-top: 0;
            }

            .quick-actions-tabs {
                gap: 4px;
                padding: 3px;
            }

            .quick-action-tab {
                padding: 6px 12px;
                font-size: 12px;
            }

            .template-input {
                width: 100px;
                font-size: 12px;
                padding: 8px 10px;
            }

            .input-wrapper {
                padding-right: 90px;
                padding-left: 20px;
            }

            .upload-button {
                right: 48px;
            }
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="ai-bg-orb orb-1"></div>
    <div class="ai-bg-orb orb-2"></div>
    <div class="ai-bg-grid"></div>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="logo">
                <div class="logo-icon">
                    <!-- Pathgen Monochrome P Mark -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" role="img">
                        <defs>
                            <filter id="chatSparkleBlur">
                                <feGaussianBlur in="SourceGraphic" stdDeviation="0.8"/>
                            </filter>
                        </defs>
                        
                        <!-- P Glyph with Facets -->
                        <g id="glyph">
                            <rect x="20" y="20" width="16" height="60" rx="8" ry="8" fill="#FFFFFF"/>
                            <path d="M 36 20 H 50 A 24 24 0 0 1 50 58 H 36 V 20 Z" fill="#FFFFFF"/>
                            <path d="M 45 28 L 58 32 L 54 40 L 42 38 Z" fill="#000000" opacity="0.3"/>
                            <path d="M 44 42 L 56 46 L 48 52 Z" fill="#000000" opacity="0.25"/>
                            <path d="M 38 26 L 42 24 L 42 34 L 38 36 Z" fill="#000000" opacity="0.2"/>
                        </g>
                        
                        <!-- Cosmic Sparkles -->
                        <g id="sparkles" opacity="0.85">
                            <circle cx="64" cy="26" r="2.5" fill="#FFFFFF" filter="url(#chatSparkleBlur)" class="sparkle-1"/>
                            <circle cx="70" cy="38" r="1.8" fill="#FFFFFF" filter="url(#chatSparkleBlur)" class="sparkle-2"/>
                            <circle cx="52" cy="35" r="1.2" fill="#FFFFFF" opacity="0.8" filter="url(#chatSparkleBlur)" class="sparkle-3"/>
                            <circle cx="58" cy="28" r="0.9" fill="#FFFFFF" opacity="0.7" class="sparkle-4"/>
                            <circle cx="24" cy="48" r="1.5" fill="#FFFFFF" filter="url(#chatSparkleBlur)" class="sparkle-5"/>
                            <circle cx="60" cy="50" r="1.0" fill="#FFFFFF" opacity="0.6" class="sparkle-6"/>
                        </g>
                    </svg>
                </div>
                <span>Pathgen v2</span>
            </a>
            
            <div class="nav-links">
                <a href="/docs.html" class="nav-link">Docs</a>
                <div class="dropdown">
                    <a href="#" class="nav-link" id="featuresBtn" onclick="toggleDropdown('features', event)">
                        Features
                        <span class="caret">▼</span>
                    </a>
                    <div class="dropdown-menu" id="featuresDropdown">
                        <a href="/analyze" class="dropdown-item">
                            <span class="dropdown-item-icon">🎮</span>
                            <span>Replay Parser</span>
                        </a>
                        <a href="/masterclass" class="dropdown-item">
                            <span class="dropdown-item-icon">📖</span>
                            <span>Masterclass</span>
                        </a>
                        <a href="/chat.html" class="dropdown-item">
                            <span class="dropdown-item-icon">💬</span>
                            <span>AI Coach</span>
                        </a>
                        <a href="/tournaments.html" class="dropdown-item">
                            <span class="dropdown-item-icon">🏆</span>
                            <span>Tournaments</span>
                        </a>
                        <a href="/tweets.html" class="dropdown-item">
                            <span class="dropdown-item-icon">🐦</span>
                            <span>Live Tweets</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="/docs.html" class="dropdown-item">
                            <span class="dropdown-item-icon">📚</span>
                            <span>Documentation</span>
                        </a>
                    </div>
                </div>
                <a href="/tournaments.html" class="nav-link">Tournaments</a>
                <a href="https://github.com/Velari-bot/PathGen-v2" class="nav-link external" target="_blank">GitHub</a>
            </div>

            <div class="nav-right">
                <a href="/pricing.html" class="nav-link">Pricing</a>
                <a href="/chat.html" class="cta-button" id="navCTA">Try For Free</a>
                <div class="dropdown">
                    <div class="user-info" id="userInfo" onclick="toggleDropdown('settings', event)">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <span class="user-name" id="navUserName">User</span>
                    </div>
                    <div class="dropdown-menu" id="settingsDropdown">
                        <a href="/chat.html" class="dropdown-item">
                            <span class="dropdown-item-icon">💬</span>
                            <span>AI Chat</span>
                        </a>
                        <a href="/tournaments.html" class="dropdown-item">
                            <span class="dropdown-item-icon">🏆</span>
                            <span>Tournaments</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="/settings.html" class="dropdown-item">
                            <span class="dropdown-item-icon">⚙️</span>
                            <span>Settings</span>
                        </a>
                        <a href="/pricing.html" class="dropdown-item">
                            <span class="dropdown-item-icon">💳</span>
                            <span>Upgrade to Pro</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item danger" onclick="logout()">
                            <span class="dropdown-item-icon">🚪</span>
                            <span>Logout</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Chat History Overlay -->
    <div class="history-overlay" id="historyOverlay" onclick="toggleChatHistory()"></div>

    <!-- Chat History Sidebar -->
    <div class="chat-history-sidebar" id="chatHistorySidebar">
        <div class="history-header">
            <div class="history-title">Chat History</div>
            <div class="header-actions">
                <button class="new-chat-btn" onclick="createNewChat()" title="New Chat">+</button>
                <button class="close-history" onclick="toggleChatHistory()">✕</button>
            </div>
        </div>
        <div class="history-list" id="historyList">
            <!-- Chat history items will be dynamically added here -->
        </div>
    </div>

    <!-- Chat History Toggle -->
    <button class="chat-history-toggle" onclick="toggleChatHistory()" title="Chat History">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
        </svg>
    </button>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Welcome State -->
        <div id="welcomeState" class="welcome-state">
            <h1 class="welcome-greeting">Nice to see you, <span id="username">Aiden</span>. What's new?</h1>
            
            <div class="suggestion-grid">
                <div class="suggestion-card" onclick="selectSuggestion('Analyze my favorite drop spots and tell me which POI has the best rotation options')">
                    <div class="suggestion-emoji">🗺️</div>
                    <div class="suggestion-title">POI Analysis</div>
                    <div class="suggestion-desc">Analyze drop spots</div>
                </div>
                <div class="suggestion-card" onclick="selectSuggestion('Show me my recent stats and where I can improve the most')">
                    <div class="suggestion-emoji">📊</div>
                    <div class="suggestion-title">My Stats</div>
                    <div class="suggestion-desc">Review performance</div>
            </div>
                <div class="suggestion-card" onclick="selectSuggestion('Give me advanced building techniques to practice for high-level ranked games')">
                    <div class="suggestion-emoji">🏗️</div>
                    <div class="suggestion-title">Building</div>
                    <div class="suggestion-desc">Improve builds</div>
        </div>
                <div class="suggestion-card" onclick="selectSuggestion('What aim training exercises should I do to improve my tracking and flicks?')">
                    <div class="suggestion-emoji">🎯</div>
                    <div class="suggestion-title">Aim Training</div>
                    <div class="suggestion-desc">Better accuracy</div>
    </div>
                <div class="suggestion-card" onclick="selectSuggestion('What tournaments are coming up and how should I prepare?')">
                    <div class="suggestion-emoji">🏆</div>
                    <div class="suggestion-title">Tournaments</div>
                    <div class="suggestion-desc">Latest competitions</div>
                </div>
                <div class="suggestion-card" onclick="selectSuggestion('Tell me about the latest Fortnite updates and meta changes')">
                    <div class="suggestion-emoji">🔄</div>
                    <div class="suggestion-title">Updates</div>
                    <div class="suggestion-desc">What's changed</div>
            </div>
                <div class="suggestion-card" onclick="selectSuggestion('Help me develop better game sense and positioning strategies')">
                    <div class="suggestion-emoji">🧠</div>
                    <div class="suggestion-title">Game Sense</div>
                    <div class="suggestion-desc">Smart positioning</div>
                </div>
                <div class="suggestion-card" onclick="selectSuggestion('Create a custom training routine for me based on my weaknesses')">
                    <div class="suggestion-emoji">💪</div>
                    <div class="suggestion-title">Training</div>
                    <div class="suggestion-desc">Custom routine</div>
            </div>
        </div>
            </div>

            <!-- Quick Actions Section (Hidden in welcome state) -->
            <div class="quick-actions hidden">
            </div>

        <!-- Quick Actions Floating Button -->
        <button class="quick-actions-float-btn" onclick="toggleQuickActionsPopup()" title="Quick Actions">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
            </svg>
        </button>

        <!-- Quick Actions Popup -->
        <div id="quickActionsPopup" class="quick-actions-popup">
            <div class="quick-actions-popup-header">
                <div class="quick-actions-popup-title">
                    <span>⚡</span>
                    Quick Actions
                </div>
                <button class="quick-actions-popup-close" onclick="toggleQuickActionsPopup()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="quick-actions-popup-content">
                <div class="quick-actions-tabs">
                    <button class="quick-action-tab active" onclick="switchQuickActionTab('prompts', event)">Example Prompts</button>
                    <button class="quick-action-tab" onclick="switchQuickActionTab('templates', event)">Templates</button>
                    <button class="quick-action-tab" onclick="switchQuickActionTab('multi', event)">Multi-Question</button>
                </div>

                <!-- Example Prompts Tab -->
                <div id="promptsTab" class="quick-actions-content active">
                    <div class="quick-action-list">
                        <div class="quick-action-item" onclick="selectSuggestion('How do I improve my edits?'); toggleQuickActionsPopup();">
                            <span class="quick-action-item-text">How do I improve my edits?</span>
                            <span class="quick-action-item-icon">→</span>
                        </div>
                        <div class="quick-action-item" onclick="selectSuggestion('What are the best keybinds for building?'); toggleQuickActionsPopup();">
                            <span class="quick-action-item-text">What are the best keybinds for building?</span>
                            <span class="quick-action-item-icon">→</span>
                        </div>
                        <div class="quick-action-item" onclick="selectSuggestion('How can I improve my aim in Fortnite?'); toggleQuickActionsPopup();">
                            <span class="quick-action-item-text">How can I improve my aim in Fortnite?</span>
                            <span class="quick-action-item-icon">→</span>
                        </div>
                        <div class="quick-action-item" onclick="selectSuggestion('What loadout should I use in ranked?'); toggleQuickActionsPopup();">
                            <span class="quick-action-item-text">What loadout should I use in ranked?</span>
                            <span class="quick-action-item-icon">→</span>
                        </div>
                        <div class="quick-action-item" onclick="selectSuggestion('How do I improve my piece control?'); toggleQuickActionsPopup();">
                            <span class="quick-action-item-text">How do I improve my piece control?</span>
                            <span class="quick-action-item-icon">→</span>
                        </div>
                    </div>
                </div>

                <!-- Templates Tab -->
                <div id="templatesTab" class="quick-actions-content">
                    <div class="quick-action-list">
                        <div class="quick-action-item" style="cursor: default;">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1; flex-wrap: wrap;">
                                <span class="quick-action-item-text" style="white-space: nowrap; color: #9ca3af; font-weight: 400;">Compare</span>
                                <input type="text" class="template-input" id="templateCompare1" placeholder="X" onkeydown="if(event.key==='Enter') useTemplate('compare')">
                                <span class="quick-action-item-text" style="white-space: nowrap; color: #9ca3af; font-weight: 400;">vs</span>
                                <input type="text" class="template-input" id="templateCompare2" placeholder="Y" onkeydown="if(event.key==='Enter') useTemplate('compare')">
                                <button class="template-submit" onclick="useTemplate('compare')">Go</button>
                            </div>
                        </div>
                        <div class="quick-action-item" style="cursor: default;">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1; flex-wrap: wrap;">
                                <span class="quick-action-item-text" style="white-space: nowrap; color: #9ca3af; font-weight: 400;">Best loadout for</span>
                                <input type="text" class="template-input" id="templateLoadout" placeholder="situation" onkeydown="if(event.key==='Enter') useTemplate('loadout')">
                                <button class="template-submit" onclick="useTemplate('loadout')">Go</button>
                            </div>
                        </div>
                        <div class="quick-action-item" style="cursor: default;">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1; flex-wrap: wrap;">
                                <span class="quick-action-item-text" style="white-space: nowrap; color: #9ca3af; font-weight: 400;">How to</span>
                                <input type="text" class="template-input" id="templateHowTo" placeholder="technique" style="width: 150px;" onkeydown="if(event.key==='Enter') useTemplate('howto')">
                                <button class="template-submit" onclick="useTemplate('howto')">Go</button>
                            </div>
                        </div>
                        <div class="quick-action-item" style="cursor: default;">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1; flex-wrap: wrap;">
                                <span class="quick-action-item-text" style="white-space: nowrap; color: #9ca3af; font-weight: 400;">Best way to practice</span>
                                <input type="text" class="template-input" id="templatePractice" placeholder="skill" onkeydown="if(event.key==='Enter') useTemplate('practice')">
                                <button class="template-submit" onclick="useTemplate('practice')">Go</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Multi-Question Tab -->
                <div id="multiTab" class="quick-actions-content">
                    <div class="multi-question-mode">
                        <div class="multi-question-header">
                            <span class="multi-question-title">
                                <span style="margin-right: 6px;">📝</span>
                                Ask Multiple Questions
                            </span>
                            <span class="multi-question-toggle" onclick="toggleMultiQuestion()">
                                <span id="multiToggleText">Enable</span>
                            </span>
                        </div>
                        <textarea 
                            id="multiQuestionInput" 
                            class="multi-question-input hidden"
                            placeholder="Ask multiple questions at once, one per line:&#10;&#10;What are the best drop spots?&#10;How do I improve my aim?&#10;What loadout should I use?"
                            rows="4"
                        ></textarea>
                    </div>
            </div>
        </div>
            </div>

        <!-- Chat State -->
        <div id="chatState" class="chat-state hidden">
            <div class="messages-container" id="messagesContainer">
                <!-- Messages will be added here dynamically -->
                </div>
            </div>
                </div>

    <!-- Input Section -->
    <div class="input-section">
        <div class="input-container">
            <div class="model-preview" id="modelPreview">
                Will use: <strong>⚡ PathGen 4o-mini</strong> - Selected 4o-mini: Simple request detected, Pro user - premium model access
                </div>

                <div class="input-wrapper">
                    <!-- File Upload Area (shown when file is being uploaded) -->
                    <div id="uploadPreview" class="hidden" style="margin-bottom: 8px;"></div>
                    
                    <textarea 
                    id="chatInput" 
                    class="chat-input" 
                    placeholder="Ask me anything about Fortnite..."
                        rows="1"
                    onkeydown="handleKeyPress(event)"
                        oninput="autoResize(this)"
                    ></textarea>
                    
                    <!-- File Upload Button -->
                    <input type="file" id="fileUpload" accept="image/*,video/*,.mp4,.webm" style="display: none;" onchange="handleFileSelect(event)">
                    <button 
                        id="uploadButton" 
                        class="send-button" 
                        onclick="document.getElementById('fileUpload').click()"
                        title="Upload image or clip"
                        style="right: 50px; background: rgba(79, 140, 255, 0.15); border: 1px solid rgba(79, 140, 255, 0.3);"
                    >
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </button>
                    
                <button id="sendButton" class="send-button" onclick="sendMessage()">
                    <svg id="sendIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                    <div id="sendSpinner" class="spinner hidden"></div>
                </button>
                        </div>
                
                <!-- Drag & Drop Upload Area -->
                <div 
                    id="dragDropArea" 
                    class="upload-area hidden"
                    ondrop="handleFileDrop(event)"
                    ondragover="handleDragOver(event)"
                    ondragleave="handleDragLeave(event)"
                    onclick="document.getElementById('fileUpload').click()"
                >
                    <div class="upload-area-content">
                        <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <div class="upload-text">Drop image or clip here</div>
                        <div class="upload-hint">or click to browse</div>
                    </div>
                </div>
            
            <div class="credit-indicator" id="creditIndicator">
                💎 Ready to chat • <span id="creditCost">1</span> credit per message
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="/firebase-config.js"></script>
    <script src="/js/admin-guard.js"></script>

    <script>
        const API_BASE = 'http://localhost:4000';
        let messages = [];
        let userCredits = 10; // Example starting credits
        let isProcessing = false;
        let currentChatId = null;
        let chats = [];
        let uploadedFile = null;
        let isMultiQuestionMode = false;

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            // Hard gate: require login/setup before using chat
            try {
                const auth = localStorage.getItem('pathgen_user') || localStorage.getItem('discordUser') || localStorage.getItem('firebaseUser');
                if (!auth) {
                    window.location.replace('/login.html');
                    return;
                }
            } catch (_) {
                window.location.replace('/login.html');
                return;
            }
            // Get user data from localStorage
            const userDataStr = localStorage.getItem('pathgen_user');
            let displayName = 'Aiden';
            let userData = null;
            
            if (userDataStr) {
                try {
                    userData = JSON.parse(userDataStr);
                    displayName = userData.name || userData.firstName || userData.email?.split('@')[0] || 'Aiden';
                    
                    // Show user info in navbar
                    const navCTA = document.getElementById('navCTA');
                    const userInfo = document.getElementById('userInfo');
                    const userAvatar = document.getElementById('userAvatar');
                    const navUserName = document.getElementById('navUserName');
                    
                    if (navCTA && userInfo && userAvatar && navUserName) {
                        navCTA.style.display = 'none';
                        userInfo.style.display = 'flex';
                        
                        // Set avatar - use Discord avatar if available
                        if (userData.discordAvatar) {
                            userAvatar.innerHTML = `<img src="${userData.discordAvatar}" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%;" />`;
                        } else {
                            const initial = (userData.name || userData.email || displayName).charAt(0).toUpperCase();
                            userAvatar.textContent = initial;
                        }
                        
                        // Set name
                        navUserName.textContent = displayName;
                    }
                } catch (e) {
                    console.error('Error parsing user data:', e);
                }
            }
            
            document.getElementById('username').textContent = displayName;
            updateCreditsDisplay();
            
            // Load chats from localStorage
            loadChats();
            renderChatHistory();
        });

        // Auto-resize textarea
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }

        // Select suggestion
        function selectSuggestion(text) {
            const input = document.getElementById('chatInput');
            input.value = text;
            autoResize(input);
            input.focus();
            // Scroll to input
            input.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Quick Actions Functions
        function toggleQuickActionsPopup() {
            const popup = document.getElementById('quickActionsPopup');
            if (popup) {
                popup.classList.toggle('open');
            }
        }

        // Close popup when clicking outside
        document.addEventListener('click', function(event) {
            const popup = document.getElementById('quickActionsPopup');
            const button = document.querySelector('.quick-actions-float-btn');
            if (popup && popup.classList.contains('open')) {
                if (!popup.contains(event.target) && !button.contains(event.target)) {
                    popup.classList.remove('open');
                }
            }
        });

        // Show/hide inline button based on welcome state
        function updateQuickActionsButton() {
            const welcomeState = document.getElementById('welcomeState');
            const floatBtn = document.querySelector('.quick-actions-float-btn');
            if (welcomeState && floatBtn) {
                if (welcomeState.classList.contains('hidden')) {
                    floatBtn.style.display = 'none';
                } else {
                    floatBtn.style.display = 'flex';
                }
            }
        }

        // Set up observer after DOM loads
        window.addEventListener('DOMContentLoaded', () => {
            // Observe welcome state changes
            const welcomeState = document.getElementById('welcomeState');
            if (welcomeState) {
                const welcomeStateObserver = new MutationObserver(updateQuickActionsButton);
                welcomeStateObserver.observe(welcomeState, { attributes: true, attributeFilter: ['class'] });
                updateQuickActionsButton(); // Initial check
            }
        });

        function switchQuickActionTab(tabName, event) {
            // Update tab buttons
            document.querySelectorAll('.quick-action-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            if (event?.target) {
                event.target.classList.add('active');
            } else {
                // Find the button that was clicked
                const buttons = document.querySelectorAll('.quick-action-tab');
                buttons.forEach(btn => {
                    if (btn.textContent.includes(tabName === 'prompts' ? 'Example' : tabName === 'templates' ? 'Template' : 'Multi')) {
                        btn.classList.add('active');
                    }
                });
            }
            
            // Update content
            document.querySelectorAll('.quick-actions-content').forEach(content => {
                content.classList.remove('active');
            });
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
        }

        // Template Functions
        function useTemplate(templateType) {
            let query = '';
            
            switch(templateType) {
                case 'compare':
                    const x = document.getElementById('templateCompare1').value.trim();
                    const y = document.getElementById('templateCompare2').value.trim();
                    if (!x || !y) {
                        alert('Please fill in both fields to compare');
                        return;
                    }
                    query = `Compare ${x} vs ${y}`;
                    break;
                case 'loadout':
                    const situation = document.getElementById('templateLoadout').value.trim();
                    if (!situation) {
                        alert('Please specify a situation');
                        return;
                    }
                    query = `Best loadout for ${situation}`;
                    break;
                case 'howto':
                    const technique = document.getElementById('templateHowTo').value.trim();
                    if (!technique) {
                        alert('Please specify a technique');
                        return;
                    }
                    query = `How to ${technique}`;
                    break;
                case 'practice':
                    const skill = document.getElementById('templatePractice').value.trim();
                    if (!skill) {
                        alert('Please specify a skill');
                        return;
                    }
                    query = `Best way to practice ${skill}`;
                    break;
            }
            
            if (query) {
                selectSuggestion(query);
                // Clear template inputs
                document.querySelectorAll('.template-input').forEach(input => {
                    input.value = '';
                });
                // Close popup
                toggleQuickActionsPopup();
            }
        }

        // Multi-Question Functions
        function toggleMultiQuestion() {
            isMultiQuestionMode = !isMultiQuestionMode;
            const input = document.getElementById('multiQuestionInput');
            const toggleText = document.getElementById('multiToggleText');
            
            if (isMultiQuestionMode) {
                input.classList.remove('hidden');
                toggleText.textContent = 'Disable';
                input.focus();
            } else {
                input.classList.add('hidden');
                toggleText.textContent = 'Enable';
                input.value = '';
            }
        }

        // File Upload Functions
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function handleFileDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const dragDropArea = document.getElementById('dragDropArea');
            dragDropArea.classList.remove('drag-over');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            const dragDropArea = document.getElementById('dragDropArea');
            dragDropArea.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            const dragDropArea = document.getElementById('dragDropArea');
            dragDropArea.classList.remove('drag-over');
        }

        function processFile(file) {
            // Validate file type
            const isImage = file.type.startsWith('image/');
            const isVideo = file.type.startsWith('video/');
            
            if (!isImage && !isVideo) {
                alert('Please upload an image or video file');
                return;
            }
            
            // Validate file size (max 10MB)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                alert('File size must be less than 10MB');
                return;
            }
            
            uploadedFile = file;
            showFilePreview(file);
            
            // Show drag-drop area as hidden (file is now in preview)
            const dragDropArea = document.getElementById('dragDropArea');
            dragDropArea.classList.add('hidden');
        }

        function showFilePreview(file) {
            const preview = document.getElementById('uploadPreview');
            preview.classList.remove('hidden');
            
            const isImage = file.type.startsWith('image/');
            
            // Only show preview for images
            if (isImage) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewHTML = `
                        <div class="file-preview-container">
                            <img src="${e.target.result}" alt="Preview" />
                            <div class="file-preview-overlay">
                                <button class="remove-file-btn-overlay" onclick="removeFile()" title="Remove file">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    preview.innerHTML = previewHTML;
                };
                reader.readAsDataURL(file);
            } else {
                // For videos, show a simple container with remove button (minimal)
                preview.innerHTML = `
                    <div class="file-preview-container" style="width: 200px; height: 120px; background: rgba(26, 26, 26, 0.9); display: flex; align-items: center; justify-content: center; position: relative;">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 40px; height: 40px; color: #4f8cff;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                        <div class="file-preview-overlay">
                            <button class="remove-file-btn-overlay" onclick="removeFile()" title="Remove file">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function removeFile() {
            uploadedFile = null;
            const preview = document.getElementById('uploadPreview');
            preview.classList.add('hidden');
            preview.innerHTML = '';
            document.getElementById('fileUpload').value = '';
        }

        // Handle key press
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Parse bold text (**text** -> <strong>text</strong>)
        function parseBoldText(text) {
            return text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        }

        // Extract YouTube video ID from URL
        function extractYouTubeVideoId(url) {
            if (!url) return null;
            try {
                const u = new URL(url);
                if (u.hostname.includes('youtu.be')) {
                    return u.pathname.replace('/', '');
                } else if (u.hostname.includes('youtube.com')) {
                    return u.searchParams.get('v') || u.pathname.split('/').pop() || null;
                }
            } catch (_) {
                // Try regex fallback
                const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/);
                return match ? match[1] : null;
            }
            return null;
        }

        // Get YouTube thumbnail URL
        function getYouTubeThumbnail(videoId, quality = 'hqdefault') {
            if (!videoId) return null;
            // Quality options: default, mqdefault, hqdefault, sddefault, maxresdefault
            return `https://img.youtube.com/vi/${videoId}/${quality}.jpg`;
        }

        // Convert seconds to timestamp format (e.g., 222 -> "3:42")
        function secondsToTimestamp(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Convert timestamp format to seconds (e.g., "3:42" -> 222)
        function timestampToSeconds(timestamp) {
            const parts = timestamp.split(':').map(Number);
            if (parts.length === 2) {
                return parts[0] * 60 + parts[1];
            } else if (parts.length === 3) {
                return parts[0] * 3600 + parts[1] * 60 + parts[2];
            }
            return 0;
        }

        // Parse and convert timestamp links in text (e.g., "See this at 3:42" -> clickable link)
        // Also links videoStart timestamps from cited video sources
        function parseTimestampLinks(text, sources = []) {
            if (!sources || sources.length === 0) return text;
            
            // Find all YouTube video sources with videoStart timestamps
            const videoSourcesWithTimestamps = sources.filter(s => {
                const url = s.videoUrl || s.url || '';
                const hasVideoUrl = url && (url.includes('youtube.com') || url.includes('youtu.be'));
                const hasStartTime = typeof s.videoStart === 'number' && s.videoStart > 0;
                return hasVideoUrl && hasStartTime;
            });
            
            // Find the first YouTube video source (fallback for general timestamp linking)
            const youtubeVideo = sources.find(s => {
                const url = s.videoUrl || s.url || '';
                return url && (url.includes('youtube.com') || url.includes('youtu.be'));
            });
            
            if (!youtubeVideo && videoSourcesWithTimestamps.length === 0) return text;
            
            // Use the first video with timestamp if available, otherwise use any YouTube video
            const primaryVideo = videoSourcesWithTimestamps.length > 0 
                ? videoSourcesWithTimestamps[0] 
                : youtubeVideo;
            
            const videoUrl = primaryVideo.videoUrl || primaryVideo.url;
            const videoId = extractYouTubeVideoId(videoUrl);
            
            if (!videoId) return text;
            
            // First, replace videoStart timestamps from sources (e.g., "See at 3:42" where 3:42 is from videoStart)
            // Create a map of timestamp strings to video sources for multi-video support
            const timestampMap = new Map();
            videoSourcesWithTimestamps.forEach(vs => {
                const vsVideoUrl = vs.videoUrl || vs.url;
                const vsVideoId = extractYouTubeVideoId(vsVideoUrl);
                if (vsVideoId && vs.videoStart) {
                    const timestampStr = secondsToTimestamp(vs.videoStart);
                    const key = timestampStr.toLowerCase();
                    if (!timestampMap.has(key)) {
                        timestampMap.set(key, {
                            videoId: vsVideoId,
                            seconds: vs.videoStart,
                            timestamp: timestampStr
                        });
                    }
                }
            });
            
            // Pattern: timestamps like "3:42", "12:34", "1:23:45"
            // Match timestamps that aren't already inside <a> tags or other HTML elements
            // Use word boundary to avoid matching part of a larger number
            const timestampPattern = /\b(\d{1,2}:\d{2}(?::\d{2})?)\b/g;
            
            // Check if text already contains HTML (like links)
            // If it does, we need to be more careful about replacement
            const hasHTML = /<[^>]+>/.test(text);
            
            if (hasHTML) {
                // For HTML content, we need to avoid replacing timestamps inside tags
                return text.replace(timestampPattern, (match, timestamp, offset, fullText) => {
                    // Check if this match is inside an HTML tag or existing link
                    const beforeMatch = fullText.substring(0, offset);
                    
                    // Count unclosed tags before this position
                    const openTags = (beforeMatch.match(/<[^/][^>]*>/g) || []).length;
                    const closeTags = (beforeMatch.match(/<\/[^>]+>/g) || []).length;
                    const isInsideTag = openTags > closeTags;
                    
                    // Also check if we're inside an existing link
                    const lastOpenLink = beforeMatch.lastIndexOf('<a ');
                    const lastCloseLink = beforeMatch.lastIndexOf('</a>');
                    const isInsideLink = lastOpenLink > lastCloseLink && lastOpenLink > -1;
                    
                    // Also check if preceded by a digit or colon (part of larger timestamp)
                    const charBefore = beforeMatch[beforeMatch.length - 1];
                    const isPartOfLarger = /[\d:]/.test(charBefore);
                    
                    if (isInsideTag || isInsideLink || isPartOfLarger) {
                        return match; // Don't replace if inside HTML tag, link, or part of larger timestamp
                    }
                    
                    // Check if this timestamp matches one from video sources
                    const timestampKey = timestamp.toLowerCase();
                    const sourceTimestamp = timestampMap.get(timestampKey);
                    
                    let seconds, targetVideoId;
                    if (sourceTimestamp) {
                        // Use the video source's timestamp (matches videoStart)
                        seconds = sourceTimestamp.seconds;
                        targetVideoId = sourceTimestamp.videoId;
                    } else {
                        // General timestamp parsing (matches any timestamp in text)
                        seconds = timestampToSeconds(timestamp);
                        targetVideoId = videoId; // Use primary video
                    }
                    
                    const fullVideoUrl = `https://www.youtube.com/watch?v=${targetVideoId}&t=${seconds}s`;
                    return `<a href="${fullVideoUrl}" target="_blank" class="timestamp-link" title="Jump to ${timestamp}">${match}</a>`;
                });
            } else {
                // For plain text, simpler replacement
                return text.replace(timestampPattern, (match, timestamp, offset, fullText) => {
                    // Check if preceded by a digit or colon (part of larger timestamp)
                    if (offset > 0) {
                        const charBefore = fullText[offset - 1];
                        if (/[\d:]/.test(charBefore)) {
                            return match; // Don't replace if part of larger timestamp
                        }
                    }
                    
                    // Check if this timestamp matches one from video sources
                    const timestampKey = timestamp.toLowerCase();
                    const sourceTimestamp = timestampMap.get(timestampKey);
                    
                    let seconds, targetVideoId;
                    if (sourceTimestamp) {
                        // Use the video source's timestamp (matches videoStart)
                        seconds = sourceTimestamp.seconds;
                        targetVideoId = sourceTimestamp.videoId;
                    } else {
                        // General timestamp parsing (matches any timestamp in text)
                        seconds = timestampToSeconds(timestamp);
                        targetVideoId = videoId; // Use primary video
                    }
                    
                    const fullVideoUrl = `https://www.youtube.com/watch?v=${targetVideoId}&t=${seconds}s`;
                    return `<a href="${fullVideoUrl}" target="_blank" class="timestamp-link" title="Jump to ${timestamp}">${match}</a>`;
                });
            }
        }

        // Removed mock responses - API only
        function getMockResponse(query) {
            // Mock responses removed - API connection required
            return {
                text: "I'm sorry, but I'm currently unable to connect to the AI service. Please check your connection and try again.",
                sources: []
            };
        }

        // Track message sent to Firebase Analytics and Firestore
        function trackMessageSent(query, sourceCount, success) {
            try {
                // Get subscription info
                const subscriptionStr = localStorage.getItem('pathgenSubscription');
                let subscription = null;
                let planType = 'unknown';
                if (subscriptionStr) {
                    try {
                        subscription = JSON.parse(subscriptionStr);
                        planType = subscription.plan || subscription.type || 'unknown';
                    } catch (e) {
                        console.error('Error parsing subscription:', e);
                    }
                }

                // Get user info
                const userDataStr = localStorage.getItem('pathgen_user');
                let userId = 'anonymous';
                if (userDataStr) {
                    try {
                        const userData = JSON.parse(userDataStr);
                        userId = userData.id || userData.email || userData.discordId || 'anonymous';
                    } catch (e) {
                        console.error('Error parsing user data:', e);
                    }
                }

                // Get current message count for this month
                const now = new Date();
                const monthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                const messageCountKey = `messageCount_${monthKey}`;
                let messageCount = parseInt(localStorage.getItem(messageCountKey) || '0', 10);
                messageCount++;
                localStorage.setItem(messageCountKey, messageCount.toString());

                // Prepare tracking data
                const trackingData = {
                    timestamp: new Date().toISOString(),
                    userId: userId,
                    planType: planType,
                    messageCount: messageCount,
                    sourceCount: sourceCount,
                    success: success,
                    queryLength: query ? query.length : 0,
                    hasFile: uploadedFile !== null,
                    chatId: currentChatId || 'new',
                    month: monthKey
                };

                // Firebase Analytics tracking
                if (window.firebaseAnalytics) {
                    try {
                        window.firebaseAnalytics.logEvent('message_sent', {
                            plan_type: planType,
                            source_count: sourceCount,
                            success: success,
                            message_count: messageCount,
                            query_length: query ? query.length : 0,
                            has_file: uploadedFile !== null
                        });
                        console.log('✅ Analytics event tracked:', 'message_sent');
                    } catch (analyticsError) {
                        console.error('Analytics tracking error:', analyticsError);
                    }
                }

                // Firestore tracking for persistence
                if (window.firebaseDb && window.firebaseAuth) {
                    const user = window.firebaseAuth.currentUser;
                    if (user) {
                        const userRef = window.firebaseDb.collection('users').doc(user.uid);
                        
                        // Get current user stats to update totals
                        userRef.get().then(doc => {
                            const currentData = doc.exists ? doc.data() : {};
                            const totalMessages = (currentData.totalMessages || 0) + 1;
                            const totalSuccessfulMessages = (currentData.totalSuccessfulMessages || 0) + (success ? 1 : 0);
                            const totalFailedMessages = (currentData.totalFailedMessages || 0) + (success ? 0 : 1);
                            const totalSources = (currentData.totalSources || 0) + sourceCount;
                            
                            // Update user document with comprehensive tracking
                            const userUpdate = {
                                // Monthly tracking
                                [`messageCount_${monthKey}`]: messageCount,
                                [`lastMessageMonth_${monthKey}`]: firebase.firestore.FieldValue.serverTimestamp(),
                                
                                // Lifetime statistics
                                totalMessages: totalMessages,
                                totalSuccessfulMessages: totalSuccessfulMessages,
                                totalFailedMessages: totalFailedMessages,
                                totalSources: totalSources,
                                
                                // Current session/period stats
                                lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
                                lastMessagePlan: planType,
                                lastMessageSuccess: success,
                                
                                // Subscription info (if available)
                                subscription: subscription || currentData.subscription || null,
                                
                                // Metadata
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            
                            // Update user document
                            userRef.set(userUpdate, { merge: true }).catch(err => {
                                console.error('Firestore user update error:', err);
                            });
                        }).catch(err => {
                            console.error('Firestore user fetch error:', err);
                            // Fallback: update without fetching current data
                            userRef.set({
                                [`messageCount_${monthKey}`]: messageCount,
                                lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            }, { merge: true }).catch(updateErr => {
                                console.error('Firestore fallback update error:', updateErr);
                            });
                        });
                        
                        // Store in user's message history subcollection
                        window.firebaseDb.collection('users').doc(user.uid).collection('messages').add({
                            ...trackingData,
                            query: query ? query.substring(0, 500) : '', // Limit query length
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        }).catch(err => {
                            console.error('Firestore message tracking error:', err);
                        });
                    } else {
                        // Store anonymously if not logged in
                        const anonymousId = localStorage.getItem('anonymousId') || `anon_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`;
                        localStorage.setItem('anonymousId', anonymousId);
                        
                        window.firebaseDb.collection('anonymous_messages').add({
                            ...trackingData,
                            anonymousId: anonymousId,
                            query: query ? query.substring(0, 500) : '',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        }).catch(err => {
                            console.error('Firestore anonymous tracking error:', err);
                        });
                    }
                }

                console.log('📊 Message tracked:', trackingData);
            } catch (error) {
                console.error('Message tracking error:', error);
                // Don't throw - tracking failures shouldn't break the app
            }
        }

        // Send message
        async function sendMessage() {
            if (isProcessing) return;
            
            // Check multi-question mode
            if (isMultiQuestionMode) {
                const multiInput = document.getElementById('multiQuestionInput');
                const multiQuery = multiInput.value.trim();
                
                if (multiQuery) {
                    // Send multi-question
                    const questions = multiQuery.split('\n').filter(q => q.trim());
                    if (questions.length > 0) {
                        const combinedQuery = questions.join('\n\n');
                        document.getElementById('chatInput').value = combinedQuery;
                        // Disable multi-question mode after sending
                        isMultiQuestionMode = false;
                        multiInput.classList.add('hidden');
                        document.getElementById('multiToggleText').textContent = 'Enable';
                        multiInput.value = '';
                    }
                }
            }
            
            const input = document.getElementById('chatInput');
            let query = input.value.trim();
            
            if (!query && !uploadedFile) return;
            
            // Handle file upload
            if (uploadedFile) {
                // For now, just add file info to query
                // In production, you'd upload the file to your API
                const fileType = uploadedFile.type.startsWith('image/') ? 'image' : 'clip';
                query = query ? `${query}\n\n[${fileType}: ${uploadedFile.name}]` : `Analyze this ${fileType}: ${uploadedFile.name}`;
            }

            // Check credits
            if (userCredits < 1) {
                showInsufficientCredits();
                return;
            }

            // Clear input
            input.value = '';
            autoResize(input);
            
            // Remove uploaded file after sending
            if (uploadedFile) {
                removeFile();
            }

            // Create new chat if none exists
            if (!currentChatId) {
                createNewChat();
            }

            // Switch to chat state
            showChatState();

            // Add user message
            addUserMessage(query);

            // Update UI
            isProcessing = true;
            updateSendButton(true);
            showLoadingIndicator();

            // Deduct credit
            userCredits--;
            updateCreditsDisplay();

            try {
                const response = await fetch(`${API_BASE}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        query,
                        conversation_history: messages.slice(-6),
                    }),
                });

                if (!response.ok) {
                    throw new Error(`API server not available`);
                }

                const data = await response.json();

                // Remove loading indicator
                removeLoadingIndicator();

                // Add AI response with sources
                const aiText = data.response || data.text;
                const aiSources = data.sources || [];
                addAIMessage(aiText, aiSources);

                // Store in conversation
                messages.push(
                    { role: 'user', content: query },
                    { role: 'assistant', content: aiText, sources: aiSources }
                );
                
                // Save chat
                saveCurrentChat();
                
                // Track message sent
                trackMessageSent(query, aiSources.length, true);

            } catch (error) {
                console.error('API error:', error);
                
                // Show error message instead of mock response
                setTimeout(() => {
                    removeLoadingIndicator();
                    
                    const errorMessage = "I'm sorry, but I'm currently unable to connect to the AI service. Please check your connection and try again later.";
                    addAIMessage(errorMessage, []);
                    
                    // Store in conversation
                    messages.push(
                        { role: 'user', content: query },
                        { role: 'assistant', content: errorMessage }
                    );
                    
                    // Track failed message
                    trackMessageSent(query, 0, false);
                }, 500);
            } finally {
                setTimeout(() => {
                    isProcessing = false;
                    updateSendButton(false);
                }, 1500);
            }
        }

        // Add user message
        function addUserMessage(text) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.style.animationDelay = '0ms';
            
            const time = new Date().toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: true 
            });
            
            messageDiv.innerHTML = `
                <div>
                    <div class="message-bubble">
                        <div class="message-content">${escapeHtml(text)}</div>
                    </div>
                    <div class="message-footer">
                        <span>${time}</span>
                    </div>
                </div>
            `;
            
            container.appendChild(messageDiv);
            scrollToLastMessage();
        }

        // Add AI message with optional sources
        function addAIMessage(text, sources = null) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai';
            messageDiv.style.animationDelay = '50ms';
            
            const time = new Date().toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: true 
            });
            
            // Parse text with timestamp links first, then bold text
            const textWithTimestamps = parseTimestampLinks(escapeHtml(text), sources || []);
            const parsedText = parseBoldText(textWithTimestamps);
            
            let sourcesHTML = '';
            // Build optional video wrappers first if any video source present
            const videoSources = (sources || []).filter(s => s.videoUrl || (s.url && (s.url.includes('youtube.com') || s.url.includes('youtu.be') || s.url.endsWith('.mp4'))));
            let videoHTML = '';
            if (videoSources.length > 0) {
                // Display ALL video sources with thumbnails, inline player, and "Watch full video" button
                const videoEmbeds = videoSources.map(vs => {
                const videoUrl = vs.videoUrl || vs.url;
                const startParam = typeof vs.videoStart === 'number' && vs.videoStart > 0 ? vs.videoStart : 0;
                    const title = vs.title || 'Video source';
                    
                    // Generate unique ID for this video citation
                    const videoId = videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be') 
                        ? extractYouTubeVideoId(videoUrl) 
                        : null;
                    
                    const thumbnailUrl = vs.thumbnailUrl || (videoId ? getYouTubeThumbnail(videoId) : null);
                    const timestampStr = startParam > 0 ? secondsToTimestamp(startParam) : null;
                    
                    // Build embed URL with start time
                    let embedSrc = '';
                    if (videoId) {
                        embedSrc = `https://www.youtube.com/embed/${videoId}${startParam > 0 ? `?start=${Math.floor(startParam)}` : ''}`;
                } else if (videoUrl.endsWith('.mp4')) {
                        embedSrc = videoUrl;
                    }
                    
                    // Build full video URL (for "Watch full video" button)
                    const fullVideoUrl = videoId 
                        ? `https://www.youtube.com/watch?v=${videoId}${startParam > 0 ? `&t=${Math.floor(startParam)}s` : ''}`
                        : videoUrl;
                    
                    let videoCitationHTML = `
                        <div class="video-citation" data-video-id="${videoId || ''}">
                    `;
                    
                    // Add thumbnail with play button (clickable to show inline player)
                    if (thumbnailUrl) {
                        videoCitationHTML += `
                            <div class="video-thumbnail-container" onclick="toggleVideoPlayer(this, '${escapeHtml(embedSrc)}')">
                                <img src="${escapeHtml(thumbnailUrl)}" alt="${escapeHtml(title)}" class="video-thumbnail" loading="lazy" />
                                <div class="video-thumbnail-overlay">
                                    <div class="video-play-icon"></div>
                            </div>
                      </div>
                        `;
                    }
                    
                    // Add inline player (hidden by default, shown when thumbnail is clicked)
                    if (embedSrc) {
                        if (videoId) {
                            // YouTube inline player
                            videoCitationHTML += `
                                <div class="video-inline-player" style="display: none;">
                                    <iframe src="${escapeHtml(embedSrc)}" title="${escapeHtml(title)}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                `;
                        } else if (videoUrl.endsWith('.mp4')) {
                            // Direct MP4 video player
                            videoCitationHTML += `
                                <div class="video-inline-player" style="display: none;">
                                    <video controls width="100%" ${startParam ? `data-start="${Math.floor(startParam)}"` : ''} src="${escapeHtml(videoUrl)}" poster="${escapeHtml(thumbnailUrl || '')}"></video>
                                </div>
                            `;
                        }
                    }
                    
                    // Add video info and actions
                    videoCitationHTML += `
                        <div class="video-info">
                            <div class="video-title">${escapeHtml(title)}</div>
                            ${timestampStr ? `<div class="video-timestamp-info">📹 Starts at ${timestampStr}</div>` : ''}
                            <div class="video-actions">
                                <a href="${escapeHtml(fullVideoUrl)}" target="_blank" class="video-action-btn" title="Watch full video on YouTube">
                                    <svg viewBox="0 0 24 24" fill="none">
                                        <path d="M15 12.3301L9 16.6603V8L15 12.3301Z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Watch Full Video
                                </a>
                                ${timestampStr ? `
                                    <a href="${escapeHtml(fullVideoUrl)}" target="_blank" class="video-action-btn" title="Jump to ${timestampStr}">
                                        <svg viewBox="0 0 24 24" fill="none">
                                            <circle cx="12" cy="12" r="10" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M12 6V12L16 14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Jump to ${timestampStr}
                                    </a>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    `;
                    
                    return videoCitationHTML;
                }).join('');
                videoHTML = videoEmbeds;
            }
            if (sources && sources.length > 0) {
                // Filter out video sources (they're shown as embedded players above)
                // Only show non-video sources as text links
                const nonVideoSources = sources.filter(s => {
                    const url = s.videoUrl || s.url || '';
                    return !(s.videoUrl || url.includes('youtube.com') || url.includes('youtu.be') || url.endsWith('.mp4'));
                });
                
                // De-duplicate by url/title and cap to top 3 for cleaner look
                const seen = new Set();
                const cleanSources = [];
                for (const s of nonVideoSources) {
                    const key = (s.url || s.videoUrl || s.title || s.source || '').toString();
                    if (!seen.has(key)) {
                        seen.add(key);
                        cleanSources.push(s);
                    }
                    if (cleanSources.length >= 3) break;
                }
                
                if (cleanSources.length > 0) {
                sourcesHTML = `
                  <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px">
                    ${cleanSources.map(source => `
                      ${source.url ? `<a href="${source.url}" target="_blank" class="source-link">View source ↗</a>` : ''}
                    `).join('')}
                  </div>
                `;
                }
            }
            
            messageDiv.innerHTML = `
                <div>
                    <div class="message-bubble">
                        <div class="message-content">${parsedText}</div>
                    </div>
                    ${videoHTML}
                    ${sourcesHTML}
                    <div class="message-footer">
                        <div class="message-actions">
                            <button class="message-action-btn" onclick="copyMessage(this)" title="Copy">
                                <svg viewBox="0 0 24 24" fill="none">
                                    <path d="M9 9h10a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2v-9a2 2 0 0 1 2-2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M15 9V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Copy
                            </button>
                            <button class="message-action-btn" onclick="regenerateMessage()" title="Regenerate">
                                <svg viewBox="0 0 24 24" fill="none">
                                    <path d="M4 4v6h6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M20 20v-6h-6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M20 8a8 8 0 0 0-15.5 2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M4 16a8 8 0 0 0 15.5-2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Regenerate
                            </button>
                        </div>
                        <span>${time}</span>
                    </div>
                </div>
            `;
            
            container.appendChild(messageDiv);
            scrollToLastMessage();
        }

        // Show loading indicator
        function showLoadingIndicator() {
            const container = document.getElementById('messagesContainer');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingIndicator';
            loadingDiv.className = 'loading-message';
            loadingDiv.innerHTML = `
                <div class="loading-bubble">
                    <span>AI is thinking</span>
                    <div class="loading-dots">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                </div>
            `;
            container.appendChild(loadingDiv);
            scrollToLastMessage();
        }

        // Remove loading indicator
        function removeLoadingIndicator() {
            const loading = document.getElementById('loadingIndicator');
            if (loading) {
                loading.remove();
            }
        }

        // Copy message
        function copyMessage(button) {
            const messageContent = button.closest('.message-footer').previousElementSibling.querySelector('.message-content').textContent;
            navigator.clipboard.writeText(messageContent);
            
            const originalText = button.innerHTML;
            button.innerHTML = '✓ Copied!';
                    setTimeout(() => {
                button.innerHTML = originalText;
                    }, 2000);
        }

        // Regenerate message
        function regenerateMessage() {
            if (messages.length >= 2) {
                // Remove last AI response from messages array
                messages.pop();
                
                // Remove last AI message from DOM
                const container = document.getElementById('messagesContainer');
                const lastAIMessage = container.querySelector('.message.ai:last-of-type');
                if (lastAIMessage) {
                    lastAIMessage.remove();
                }
                
                // Get last user query
                const lastUserMessage = messages[messages.length - 1].content;
                
                // Resend
                isProcessing = true;
                updateSendButton(true);
                showLoadingIndicator();
                
                fetch(`${API_BASE}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        query: lastUserMessage,
                        conversation_history: messages.slice(0, -1),
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    removeLoadingIndicator();
                    const aiText = data.response || data.text;
                    const aiSources = data.sources || [];
                    addAIMessage(aiText, aiSources);
                    messages.push({ role: 'assistant', content: aiText });
                })
                .catch(error => {
                    removeLoadingIndicator();
                    // API connection required - no mock responses
                    addAIMessage("I'm sorry, but I'm currently unable to connect to the AI service. Please check your connection and try again later.", []);
                    messages.push({ role: 'assistant', content: "I'm sorry, but I'm currently unable to connect to the AI service. Please check your connection and try again later." });
                })
                .finally(() => {
                    isProcessing = false;
                    updateSendButton(false);
                });
            }
        }

        // Update send button
        function updateSendButton(loading) {
            const button = document.getElementById('sendButton');
            const icon = document.getElementById('sendIcon');
            const spinner = document.getElementById('sendSpinner');
            
            if (loading) {
                button.classList.add('loading');
                button.disabled = true;
                icon.classList.add('hidden');
                spinner.classList.remove('hidden');
            } else {
                button.classList.remove('loading');
                button.disabled = false;
                icon.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        }

        // Show chat state
        function showChatState() {
            document.getElementById('welcomeState').classList.add('hidden');
            document.getElementById('chatState').classList.remove('hidden');
        }

        // Scroll to last message
        function scrollToLastMessage() {
            setTimeout(() => {
                const container = document.getElementById('messagesContainer');
                const messages = container.querySelectorAll('.message, .loading-message');
                if (messages.length > 0) {
                    const lastMessage = messages[messages.length - 1];
                    lastMessage.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        // Update credits display
        function updateCreditsDisplay() {
            const indicator = document.getElementById('creditIndicator');
            if (userCredits < 1) {
                indicator.classList.add('insufficient');
                indicator.innerHTML = `
                    Need credits to continue 
                    <button class="get-credits-btn" onclick="getCredits()">Get Credits</button>
                `;
            } else {
                indicator.classList.remove('insufficient');
                indicator.innerHTML = `💎 Ready to chat • <span id="creditCost">1</span> credit per message`;
            }
        }

        // Show insufficient credits
        function showInsufficientCredits() {
            alert('You need more credits to send a message. Please get more credits to continue.');
        }

        // Get credits (placeholder)
        function getCredits() {
            alert('Redirect to credits purchase page...');
            // window.location.href = '/credits';
        }

        // Toggle chat history
        function toggleChatHistory() {
            const sidebar = document.getElementById('chatHistorySidebar');
            const overlay = document.getElementById('historyOverlay');
            const toggleBtn = document.querySelector('.chat-history-toggle');
            
            const isOpen = sidebar.classList.contains('open');
            
            if (isOpen) {
                // Closing
                sidebar.classList.remove('open');
                overlay.classList.remove('open');
                toggleBtn.classList.remove('hidden');
            } else {
                // Opening
                sidebar.classList.add('open');
                overlay.classList.add('open');
                toggleBtn.classList.add('hidden');
            }
        }
        
        // Close chat history if it is open (do not auto-open)
        function closeChatHistoryIfOpen() {
            const sidebar = document.getElementById('chatHistorySidebar');
            const overlay = document.getElementById('historyOverlay');
            const toggleBtn = document.querySelector('.chat-history-toggle');
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                overlay.classList.remove('open');
                toggleBtn.classList.remove('hidden');
            }
        }

        // Toggle dropdown
        function toggleDropdown(type, event) {
            if (event) event.preventDefault();
            
            const dropdowns = {
                features: document.getElementById('featuresDropdown'),
                settings: document.getElementById('settingsDropdown')
            };
            
            const currentDropdown = dropdowns[type];
            if (!currentDropdown) return;
            
            // Close other dropdowns
            Object.entries(dropdowns).forEach(([key, dropdown]) => {
                if (key !== type && dropdown) {
                    dropdown.classList.remove('show');
                }
            });
            
            // Toggle current dropdown
            currentDropdown.classList.toggle('show');
            
            if (event) event.stopPropagation();
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('pathgen_user');
                localStorage.removeItem('discordUser');
                localStorage.removeItem('setupComplete');
                window.location.href = '/login.html';
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Toggle video player (show/hide inline player when thumbnail is clicked)
        function toggleVideoPlayer(thumbnailContainer, embedSrc) {
            const citation = thumbnailContainer.closest('.video-citation');
            const inlinePlayer = citation.querySelector('.video-inline-player');
            const thumbnailDiv = citation.querySelector('.video-thumbnail-container');
            
            if (inlinePlayer) {
                if (inlinePlayer.style.display === 'none') {
                    // Show inline player, hide thumbnail
                    inlinePlayer.style.display = 'block';
                    if (thumbnailDiv) thumbnailDiv.style.display = 'none';
                } else {
                    // Hide inline player, show thumbnail
                    inlinePlayer.style.display = 'none';
                    if (thumbnailDiv) thumbnailDiv.style.display = 'block';
                }
            }
        }

        // Chat Management Functions
        function loadChats() {
            const savedChats = localStorage.getItem('pathgen_chats');
            if (savedChats) {
                try {
                    chats = JSON.parse(savedChats);
                } catch (e) {
                    console.error('Error loading chats:', e);
                    chats = [];
                }
            } else {
                chats = [];
            }
        }

        function saveChats() {
            localStorage.setItem('pathgen_chats', JSON.stringify(chats));
        }

        function createNewChat() {
            // Save current chat if it has messages
            if (currentChatId && messages.length > 0) {
                saveCurrentChat();
            }

            // Create new chat
            const newChatId = 'chat_' + Date.now();
            currentChatId = newChatId;
            messages = [];
            
            // Reset UI
            document.getElementById('welcomeState').classList.remove('hidden');
            document.getElementById('chatState').classList.add('hidden');
            document.getElementById('messagesContainer').innerHTML = '';
            document.getElementById('chatInput').value = '';
            
            // Add to chats array
            chats.unshift({
                id: newChatId,
                title: 'New Chat',
                messages: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            });
            
            saveChats();
            renderChatHistory();
            
            // Close sidebar
            closeChatHistoryIfOpen();
        }

        function saveCurrentChat() {
            if (!currentChatId) return;
            
            const chatIndex = chats.findIndex(c => c.id === currentChatId);
            // Use first user message as title, or keep existing title if chat already exists
            let title = 'New Chat';
            if (messages.length > 0) {
                const firstUserMessage = messages.find(m => m.role === 'user');
                if (firstUserMessage) {
                    title = firstUserMessage.content.substring(0, 50);
                }
            }
            
            if (chatIndex !== -1) {
                chats[chatIndex].messages = messages;
                // Only update title if it's still "New Chat" or empty
                if (!chats[chatIndex].title || chats[chatIndex].title === 'New Chat') {
                    chats[chatIndex].title = title;
                }
                chats[chatIndex].updatedAt = new Date().toISOString();
            } else {
                chats.unshift({
                    id: currentChatId,
                    title: title,
                    messages: messages,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
            }
            
            saveChats();
            renderChatHistory();
        }

        function loadChat(chatId) {
            // Save current chat if it has messages
            if (currentChatId && messages.length > 0) {
                saveCurrentChat();
            }

            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;

            currentChatId = chatId;
            messages = chat.messages || [];

            // Clear and render messages
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';

            if (messages.length > 0) {
                showChatState();
                
                // Render messages without animation delays for loaded chats
                messages.forEach((msg) => {
                    if (msg.role === 'user') {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'message user';
                        const time = new Date().toLocaleTimeString('en-US', { 
                            hour: 'numeric', 
                            minute: '2-digit', 
                            second: '2-digit',
                            hour12: true 
                        });
                        messageDiv.innerHTML = `
                            <div>
                                <div class="message-bubble">
                                    <div class="message-content">${escapeHtml(msg.content)}</div>
                                </div>
                                <div class="message-footer">
                                    <span>${time}</span>
                                </div>
                            </div>
                        `;
                        container.appendChild(messageDiv);
                    } else if (msg.role === 'assistant') {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'message ai';
                        const time = new Date().toLocaleTimeString('en-US', { 
                            hour: 'numeric', 
                            minute: '2-digit', 
                            second: '2-digit',
                            hour12: true 
                        });
                        // Parse text with timestamp links first, then bold text
                        const textWithTimestamps = parseTimestampLinks(escapeHtml(msg.content), msg.sources || []);
                        const parsedText = parseBoldText(textWithTimestamps);
                        
                        let sourcesHTML = '';
                        // Build optional video wrappers first if any video source present
                        const videoSources = (msg.sources || []).filter(s => s.videoUrl || (s.url && (s.url.includes('youtube.com') || s.url.includes('youtu.be') || s.url.endsWith('.mp4'))));
                        let videoHTML = '';
                        if (videoSources.length > 0) {
                            // Display ALL video sources with thumbnails, inline player, and "Watch full video" button
                            const videoEmbeds = videoSources.map(vs => {
                                const videoUrl = vs.videoUrl || vs.url;
                                const startParam = typeof vs.videoStart === 'number' && vs.videoStart > 0 ? vs.videoStart : 0;
                                const title = vs.title || 'Video source';
                                
                                // Generate unique ID for this video citation
                                const videoId = videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be') 
                                    ? extractYouTubeVideoId(videoUrl) 
                                    : null;
                                
                                const thumbnailUrl = vs.thumbnailUrl || (videoId ? getYouTubeThumbnail(videoId) : null);
                                const timestampStr = startParam > 0 ? secondsToTimestamp(startParam) : null;
                                
                                // Build embed URL with start time
                                let embedSrc = '';
                                if (videoId) {
                                    embedSrc = `https://www.youtube.com/embed/${videoId}${startParam > 0 ? `?start=${Math.floor(startParam)}` : ''}`;
                                } else if (videoUrl.endsWith('.mp4')) {
                                    embedSrc = videoUrl;
                                }
                                
                                // Build full video URL (for "Watch full video" button)
                                const fullVideoUrl = videoId 
                                    ? `https://www.youtube.com/watch?v=${videoId}${startParam > 0 ? `&t=${Math.floor(startParam)}s` : ''}`
                                    : videoUrl;
                                
                                let videoCitationHTML = `
                                    <div class="video-citation" data-video-id="${videoId || ''}">
                                `;
                                
                                // Add thumbnail with play button (clickable to show inline player)
                                if (thumbnailUrl) {
                                    videoCitationHTML += `
                                        <div class="video-thumbnail-container" onclick="toggleVideoPlayer(this, '${escapeHtml(embedSrc)}')">
                                            <img src="${escapeHtml(thumbnailUrl)}" alt="${escapeHtml(title)}" class="video-thumbnail" loading="lazy" />
                                            <div class="video-thumbnail-overlay">
                                                <div class="video-play-icon"></div>
                                    </div>
                                        </div>
                                    `;
                                }
                                
                                // Add inline player (hidden by default, shown when thumbnail is clicked)
                                if (embedSrc) {
                                    if (videoId) {
                                        // YouTube inline player
                                        videoCitationHTML += `
                                            <div class="video-inline-player" style="display: none;">
                                                <iframe src="${escapeHtml(embedSrc)}" title="${escapeHtml(title)}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                            </div>
                                        `;
                                    } else if (videoUrl.endsWith('.mp4')) {
                                        // Direct MP4 video player
                                        videoCitationHTML += `
                                            <div class="video-inline-player" style="display: none;">
                                                <video controls width="100%" ${startParam ? `data-start="${Math.floor(startParam)}"` : ''} src="${escapeHtml(videoUrl)}" poster="${escapeHtml(thumbnailUrl || '')}"></video>
                                            </div>
                                        `;
                                    }
                                }
                                
                                // Add video info and actions
                                videoCitationHTML += `
                                    <div class="video-info">
                                        <div class="video-title">${escapeHtml(title)}</div>
                                        ${timestampStr ? `<div class="video-timestamp-info">📹 Starts at ${timestampStr}</div>` : ''}
                                        <div class="video-actions">
                                            <a href="${escapeHtml(fullVideoUrl)}" target="_blank" class="video-action-btn" title="Watch full video on YouTube">
                                                <svg viewBox="0 0 24 24" fill="none">
                                                    <path d="M15 12.3301L9 16.6603V8L15 12.3301Z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                    <path d="M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                                Watch Full Video
                                            </a>
                                            ${timestampStr ? `
                                                <a href="${escapeHtml(fullVideoUrl)}" target="_blank" class="video-action-btn" title="Jump to ${timestampStr}">
                                                    <svg viewBox="0 0 24 24" fill="none">
                                                        <circle cx="12" cy="12" r="10" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                        <path d="M12 6V12L16 14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                    </svg>
                                                    Jump to ${timestampStr}
                                                </a>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                                `;
                                
                                return videoCitationHTML;
                            }).join('');
                            videoHTML = videoEmbeds;
                        }
                        
                        // Filter out video sources (they're shown as embedded players above)
                        // Only show non-video sources as text links
                        const nonVideoSources = (msg.sources || []).filter(s => {
                            const url = s.videoUrl || s.url || '';
                            return !(s.videoUrl || url.includes('youtube.com') || url.includes('youtu.be') || url.endsWith('.mp4'));
                        });
                        
                        // De-duplicate by url/title and cap to top 3 for cleaner look
                        const seen = new Set();
                        const cleanSources = [];
                        for (const s of nonVideoSources) {
                            const key = (s.url || s.videoUrl || s.title || s.source || '').toString();
                            if (!seen.has(key)) {
                                seen.add(key);
                                cleanSources.push(s);
                            }
                            if (cleanSources.length >= 3) break;
                        }
                        
                        if (cleanSources.length > 0) {
                            sourcesHTML = `
                                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px">
                                    ${cleanSources.map(source => `
                                        ${source.url ? `<a href="${source.url}" target="_blank" class="source-link">View source ↗</a>` : ''}
                                    `).join('')}
                                </div>
                            `;
                        }
                        
                        messageDiv.innerHTML = `
                            <div>
                                <div class="message-bubble">
                                    <div class="message-content">${parsedText}</div>
                                </div>
                                ${videoHTML}
                                ${sourcesHTML}
                                <div class="message-footer">
                                    <div class="message-actions">
                                        <button class="message-action-btn" onclick="copyMessage(this)" title="Copy">
                                            <svg viewBox="0 0 24 24" fill="none">
                                                <path d="M9 9h10a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2v-9a2 2 0 0 1 2-2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                <path d="M15 9V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            Copy
                                        </button>
                                        <button class="message-action-btn" onclick="regenerateMessage()" title="Regenerate">
                                            <svg viewBox="0 0 24 24" fill="none">
                                                <path d="M4 4v6h6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                <path d="M20 20v-6h-6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                <path d="M20 8a8 8 0 0 0-15.5 2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                <path d="M4 16a8 8 0 0 0 15.5-2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            Regenerate
                                        </button>
                                    </div>
                                    <span>${time}</span>
                                </div>
                            </div>
                        `;
                        container.appendChild(messageDiv);
                    }
                });
                
                scrollToLastMessage();
            } else {
                document.getElementById('welcomeState').classList.remove('hidden');
                document.getElementById('chatState').classList.add('hidden');
            }

            renderChatHistory();
            closeChatHistoryIfOpen();
        }

        function renderChatHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            if (chats.length === 0) {
                historyList.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 24px; font-size: 14px;">No chats yet. Create a new chat to get started!</div>';
                return;
            }

            chats.forEach(chat => {
                const item = document.createElement('div');
                item.className = 'history-item';
                if (chat.id === currentChatId) {
                    item.classList.add('active');
                }
                
                const title = chat.title || 'New Chat';
                const date = formatChatDate(chat.updatedAt || chat.createdAt);
                
                item.innerHTML = `
                    <div class="history-item-title">${escapeHtml(title)}</div>
                    <div class="history-item-date">${date}</div>
                    <div class="history-item-actions">
                        <button class="history-action-btn" title="Copy share link" onclick="event.stopPropagation(); shareChat('${chat.id}')">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M10 14L8 16C6.343 17.657 6.343 20.343 8 22C9.657 23.657 12.343 23.657 14 22L16 20" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M14 10L16 8C17.657 6.343 17.657 3.657 16 2C14.343 0.343 11.657 0.343 10 2L8 4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M9 15L15 9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="history-action-btn" title="Rename chat" onclick="event.stopPropagation(); renameChat('${chat.id}')">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M12 20h9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4 12.5-12.5z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="history-action-btn danger" title="Delete chat" onclick=\"event.stopPropagation(); deleteChat('${chat.id}')\">
                            <svg viewBox=\"0 0 24 24\" fill=\"none\">
                                <path d=\"M3 6h18\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>
                                <path d=\"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>
                                <path d=\"M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>
                                <path d=\"M10 11v6M14 11v6\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>
                            </svg>
                        </button>
                    </div>
                `;
                
                item.onclick = () => loadChat(chat.id);
                historyList.appendChild(item);
            });
        }

        function formatChatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 14) return 'Last week';
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
            if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;
            return date.toLocaleDateString();
        }

        // Delete a chat by id
        function deleteChat(chatId) {
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;
            const ok = confirm(`Delete chat "${chat.title || 'New Chat'}"? This cannot be undone.`);
            if (!ok) return;

            chats = chats.filter(c => c.id !== chatId);
            if (currentChatId === chatId) {
                currentChatId = null;
                messages = [];
                document.getElementById('messagesContainer').innerHTML = '';
                document.getElementById('chatState').classList.add('hidden');
                document.getElementById('welcomeState').classList.remove('hidden');
            }
            saveChats();
            renderChatHistory();
        }

        // Share a chat: generates a share URL with encoded chat payload; clipboard copy
        async function shareChat(chatId) {
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;

            // Create compact payload and encode as base64 for URL
            const compact = {
                t: chat.title || 'New Chat',
                m: (chat.messages || []).map(m => ({ r: m.role, c: m.content, s: m.sources })),
                c: chat.createdAt,
                u: chat.updatedAt
            };
            const json = JSON.stringify(compact);
            const b64 = btoa(unescape(encodeURIComponent(json)));
            const link = `${location.origin}/chat.html#share=${b64}`;

            try {
                await navigator.clipboard.writeText(link);
                alert('Share link copied to clipboard! Send it to anyone to import this chat.');
            } catch (e) {
                console.error('Clipboard copy failed', e);
                alert('Failed to copy link. Please try again.');
            }
        }

        // Rename chat
        function renameChat(chatId) {
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;
            const name = prompt('Rename chat:', chat.title || 'New Chat');
            if (!name) return;
            chat.title = name.trim();
            chat.updatedAt = new Date().toISOString();
            saveChats();
            renderChatHistory();
            if (currentChatId === chatId) {
                // No additional UI changes needed; title shows in history list
            }
        }
    </script>
</body>
</html>
